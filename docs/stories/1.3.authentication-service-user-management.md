# Story 1.3: CloudKit Authentication and User Role Setup

## Status
Ready for Development

## Story
**As a** user (athlete, coach, or admin),
**I want** to automatically sign in with my Apple ID and select my role,
**so that** I can access the app with my appropriate permissions and have my data synced across my devices.

## Acceptance Criteria
1. CloudKit authentication integrated with automatic Apple ID sign-in
2. User role selection screen created (Athlete, Coach, Admin)
3. SwiftData models created for Athlete with user roles
4. CloudKit container configured for automatic data sync
5. iCloud account status checking and error handling
6. Initial user profile creation with role assignment
7. Data model container configured for CloudKit sync
8. User onboarding flow for first-time users
9. Settings screen for changing user role (if allowed)
10. Unit tests cover CloudKit integration and user role management

## Tasks / Subtasks
- [ ] Configure CloudKit container and authentication (AC: 1, 4)
  - [ ] Enable CloudKit capability in Xcode project
  - [ ] Configure CloudKit container identifier in entitlements
  - [ ] Set up CloudKit database schema for SwiftData models
  - [ ] Implement CloudKit account status checking
  - [ ] Add iCloud sign-in requirement handling
- [ ] Create SwiftData models with CloudKit sync (AC: 3, 7)
  - [ ] Create Athlete SwiftData model with UserRole enum
  - [ ] Add BoatType enum for user preferences
  - [ ] Configure ModelContainer with CloudKit automatic sync
  - [ ] Implement data model relationships and constraints
  - [ ] Add model versioning for future migrations
- [ ] Implement authentication manager and state (AC: 1, 5, 6)
  - [ ] Create AuthenticationManager for CloudKit status checking
  - [ ] Add CloudKitAuthenticationViewModel with @Published properties
  - [ ] Implement automatic iCloud account detection
  - [ ] Handle authentication state changes and errors
  - [ ] Add proper error messaging for iCloud issues
- [ ] Create user role selection and onboarding UI (AC: 2, 8, 9)
  - [ ] Create RoleSelectionView with role picker
  - [ ] Add OnboardingView for first-time users
  - [ ] Create UserProfileView for role management
  - [ ] Implement proper form validation and user feedback
  - [ ] Add loading states for CloudKit operations
  - [ ] Follow iOS 15+ SwiftUI compatibility requirements
- [ ] Implement user profile management (AC: 6, 9)
  - [ ] Create initial user profile on first launch
  - [ ] Add user role assignment and validation logic
  - [ ] Implement profile editing functionality
  - [ ] Add data validation and error handling
  - [ ] Ensure proper CloudKit sync for profile updates
- [ ] Implement comprehensive testing (AC: 10)
  - [ ] Create unit tests for AuthenticationManager using XCTest
  - [ ] Add unit tests for CloudKitAuthenticationViewModel
  - [ ] Create mock CloudKit container for testing
  - [ ] Add SwiftData model tests with in-memory containers
  - [ ] Implement UI tests for role selection and onboarding flows
  - [ ] Ensure 90% code coverage per coding standards

## Dev Notes

### Previous Story Insights
From Story 1.2 completion:
- GitHub Actions CI/CD pipeline is operational and runs on every PR
- SwiftLint configuration is enforced with zero error tolerance
- XCTest framework is properly integrated with mock services pattern
- Test coverage reporting is configured with 80% minimum threshold
- Project structure follows monorepo pattern with iOS app in `ios-app/` directory

### Technical Architecture Context
[Source: docs/architecture/tech-stack.md]
- **Authentication Method**: CloudKit with automatic Apple ID authentication (zero-config)
- **Local Data Storage**: SwiftData for iOS 17+, Core Data fallback for iOS 15-16
- **Cloud Sync**: CloudKit automatic synchronization across user devices
- **iOS Framework**: SwiftUI + UIKit hybrid for iOS 15+ compatibility
- **State Management**: Combine + @Published properties for reactive state

### SwiftData Models and CloudKit Integration
[Source: docs/architecture/data-models.md]
```swift
@Model
class Athlete {
    @Attribute(.unique) var id: UUID
    var name: String
    var email: String // CloudKit provides via Apple ID
    var teamID: UUID?
    var profileImageData: Data?
    var preferredBoat: BoatType?
    var weight: Double?
    var height: Double?
    var userRole: UserRole // Athlete, Coach, Admin
    var createdAt: Date
    var modifiedAt: Date
    var isActive: Bool
    
    @Relationship(deleteRule: .cascade) var sessions: [RowingSession] = []
}

enum UserRole: String, Codable, CaseIterable {
    case athlete = "athlete"
    case coach = "coach" 
    case admin = "admin"
}
```

[Source: docs/architecture/api-specification.md]
- **CloudKit Native Operations**: Automatic CRUD via SwiftData + CloudKit sync
- **Authentication**: Apple ID integration, no custom endpoints needed
- **Data Sync**: Automatic cross-device synchronization via CloudKit

### Security Requirements
[Source: docs/architecture/security.md]
- **CloudKit Security**: Automatic AES-256 encryption, Apple ID 2FA authentication
- **Data Protection**: Private CloudKit database - user can only access their own data
- **Device Security**: iOS Keychain for PM5 device credentials only
- **Privacy**: GDPR compliance via local data export/deletion capabilities
- **Error Handling**: Secure error messages, no sensitive data exposure

### File Locations and Project Structure
Based on monorepo structure and coding standards:
- **SwiftData Models**: `ios-app/d_n_w/Models/Athlete.swift`
- **CloudKit Authentication**: `ios-app/d_n_w/Services/AuthenticationManager.swift`
- **Authentication Views**: `ios-app/d_n_w/Views/Authentication/`
  - `RoleSelectionView.swift`
  - `OnboardingView.swift`
  - `UserProfileView.swift`
- **Authentication ViewModels**: `ios-app/d_n_w/ViewModels/CloudKitAuthenticationViewModel.swift`
- **Data Container**: `ios-app/d_n_w/DataModel/DataManager.swift`
- **iOS Unit Tests**: `ios-app/d_n_wTests/CloudKitAuthenticationTests/`
- **iOS UI Tests**: `ios-app/d_n_wUITests/OnboardingUITests/`

### iOS Development Requirements
[Source: docs/architecture/coding-standards.md]
- **Architecture Pattern**: Strict MVVM separation with @StateObject/@ObservedObject
- **Swift Version**: 5.5+ with iOS 15+ compatibility, SwiftData for iOS 17+
- **Error Handling**: Use Result<Success, Failure> types, no force unwrapping
- **Async/Await**: Use modern Swift concurrency with @MainActor for UI updates
- **Memory Management**: Use weak references for delegates and closures
- **Data Persistence**: SwiftData with CloudKit sync configuration

### Testing Requirements
[Source: docs/architecture/testing-strategy.md]
- **Testing Framework**: XCTest (native iOS testing framework)
- **Test File Location**: `ios-app/d_n_wTests/AuthenticationTests/`
- **Coverage Requirement**: 90% minimum code coverage per coding standards
- **Testing Patterns**: 
  - Follow TDD approach (RED-GREEN-REFACTOR cycle)
  - Use AAA pattern (Arrange, Act, Assert)
  - Test naming: `test_methodName_condition_expectedResult`
- **Mock Strategy**: Create MockAuthenticationService implementing AuthenticationServiceProtocol
- **UI Testing**: Test complete login/registration flows in `ios-app/d_n_wUITests/`

### CloudKit Configuration Requirements
[Source: docs/architecture/tech-stack.md]
- **Container Setup**: CloudKit container with proper entitlements
- **Database Configuration**: CloudKit private database for user data
- **Schema Management**: Automatic schema creation from SwiftData models
- **Sync Configuration**: ModelContainer with cloudKitDatabase: .automatic
- **Error Handling**: CloudKit account status validation and error recovery

### SwiftUI Implementation Guidelines
[Source: docs/architecture/coding-standards.md]
- **State Management**: Use @Published for authentication state, @StateObject for ownership
- **View Decomposition**: Break down complex authentication flows into focused components
- **Accessibility**: MANDATORY accessibility labels for all authentication UI elements
- **Error Display**: Implement proper error states with clear user messaging

### CloudKit Authentication Implementation
[Source: docs/architecture/security.md]
```swift
// CloudKit authentication pattern - no tokens needed
struct AuthenticationManager {
    static func checkAuthenticationStatus() async throws -> CKAccountStatus {
        let container = CKContainer.default()
        return try await container.accountStatus()
    }
    
    static func getCurrentUserID() async throws -> CKRecord.ID {
        let container = CKContainer.default()
        return try await container.userRecordID()
    }
    
    static func handleAuthenticationState(_ status: CKAccountStatus) -> AuthState {
        switch status {
        case .available: return .authenticated
        case .noAccount: return .needsICloudSignIn
        case .restricted: return .restricted
        case .couldNotDetermine: return .unknown
        @unknown default: return .unknown
        }
    }
}
```

### Technical Constraints
- **iOS Version**: Minimum iOS 15.0 deployment target for iPhone 6S+ devices
- **SwiftData**: iOS 17+ for full SwiftData support, Core Data fallback for iOS 15-16
- **CloudKit**: Requires iCloud account, graceful handling when unavailable
- **Performance**: CloudKit authentication should complete within 1 second
- **Offline Support**: App should work offline with local SwiftData, sync when connected

## Testing

### Testing Standards from Architecture
[Source: docs/architecture/testing-strategy.md and coding-standards.md]
- **Test Framework**: XCTest (native iOS testing framework)
- **Test File Location**: Tests in `ios-app/d_n_wTests/AuthenticationTests/` and `ios-app/d_n_wUITests/AuthenticationUITests/`
- **Coverage Requirement**: 90% minimum code coverage with CI enforcement
- **Testing Patterns**: 
  - Follow TDD approach (RED-GREEN-REFACTOR cycle)
  - Use AAA pattern (Arrange, Act, Assert)
  - Test naming: `test_methodName_condition_expectedResult`
  - Unit tests for AuthenticationService and ViewModels
  - Integration tests for full authentication flows
  - UI tests for login/registration user journeys
- **Mock Strategy**: 
  - Create MockAuthenticationService implementing AuthenticationServiceProtocol
  - Use dependency injection for testable architecture
  - Mock network responses for offline testing
- **CloudKit Testing**: Mock CloudKit containers for unit testing
- **Security Testing**: Test token validation, secure storage, and error scenarios

## Git Workflow

### Branch Information
**Feature Branch**: `feature/story-1.3-cloudkit-authentication-user-roles`
**Base Branch**: `develop`
**GitHub Issue**: #3

### Workflow Commands
```bash
# Pre-Development Setup
git checkout main && git pull origin main
git checkout develop 2>/dev/null || git checkout -b develop
git merge main --no-ff && git push -u origin develop
git checkout -b feature/story-1.3-cloudkit-authentication-user-roles
git push -u origin feature/story-1.3-cloudkit-authentication-user-roles

# Development Commits
git add . && git commit -m "Implement [feature]: [description]

- Description of specific changes
- Reference to AC or task completed

ðŸ¤– Generated with [Claude Code](https://claude.ai/code)
Co-Authored-By: Claude <noreply@anthropic.com>"
git push origin feature/story-1.3-cloudkit-authentication-user-roles

# Story Completion
git add . && git commit -m "Complete Story 1.3: CloudKit Authentication and User Role Setup

âœ… All Acceptance Criteria Met:
- AC1: CloudKit authentication integrated with automatic Apple ID sign-in
- AC2: User role selection screen created (Athlete, Coach, Admin)
- AC3: SwiftData models created for Athlete with user roles
- AC4: CloudKit container configured for automatic data sync
- AC5: iCloud account status checking and error handling
- AC6: Initial user profile creation with role assignment
- AC7: Data model container configured for CloudKit sync
- AC8: User onboarding flow for first-time users
- AC9: Settings screen for changing user role (if allowed)
- AC10: Unit tests cover CloudKit integration and user role management

ðŸ¤– Generated with [Claude Code](https://claude.ai/code)
Co-Authored-By: Claude <noreply@anthropic.com>"

gh pr create --title "Story 1.3: CloudKit Authentication and User Role Setup" --base develop
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-09 | 1.0 | Initial story creation with full architecture context | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
[To be populated by development agent]

### Git Workflow Execution
[To be populated by development agent]

### Debug Log References
[To be populated by development agent]

### Completion Notes List
[To be populated by development agent]

### File List
[To be populated by development agent]

## QA Results
[To be populated by QA agent]